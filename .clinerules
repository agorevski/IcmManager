# Xbox Reddit ICM Manager - Cline Rules

## Project Overview
This is an automated issue detection utility that monitors Xbox-related Reddit subreddits to detect user-reported issues and automatically creates ICMs (Incident/Case Management tickets) for Microsoft investigation.

## Architecture Principles

### Interface-Based Design
- All major components must implement abstract interfaces defined in `src/interfaces/`
- This allows implementations to be swapped without changing dependent code
- Interfaces: `IRedditClient`, `ILLMAnalyzer`, `IICMManager`, `IPostTracker`

### Component Responsibilities
- `src/models/` - Data classes only, no business logic
- `src/interfaces/` - Abstract base classes defining contracts
- `src/analyzers/` - LLM analyzer implementations
- `src/tracking/` - Post tracking implementations
- `src/logging/` - Logging utilities
- `src/pipeline/` - Orchestration logic
- `tests/` - Unit tests with pytest
- `tests/test_assets/` - JSON fixtures for testing (sample Reddit posts)

## Coding Standards

### Python Conventions
- Use Python 3.10+ features (tested on 3.10, 3.11, 3.12, 3.13)
- Use dataclasses for data models
- Use type hints for all function signatures
- Use docstrings for all public classes and methods
- Follow PEP 8 style guidelines

### File Organization
- Keep prompts in YAML files (`prompts.yaml`) for maintainability
- Configuration via environment variables (see `src/config.py`)
- One class per file when practical

### Testing Requirements
- All new features must have corresponding unit tests
- Use pytest fixtures from `tests/conftest.py`
- Mock external dependencies (Reddit API, Azure OpenAI, ICM API)
- Tests should pass before committing
- E2E tests in `test_e2e_classification.py` require Azure OpenAI credentials
- Test assets go in `tests/test_assets/` as JSON files

## Key Files to Know

### Entry Points
- `src/pipeline/issue_detector.py` - Main pipeline orchestrator
- `src/config.py` - Configuration management

### Data Models
- `src/models/reddit_data.py` - RedditPost, RedditComment
- `src/models/issue.py` - IssueAnalysis, ICMIssue, AnalyzedPost, Severity, IssueCategory enums

### Implementations
- `src/analyzers/azure_openai_analyzer.py` - LLM analyzer (uses prompts.yaml)
- `src/analyzers/prompts.yaml` - LLM prompts (system_prompt, duplicate_check_prompt)
- `src/tracking/sqlite_tracker.py` - SQLite-based post tracker
- `src/logging/llm_logger.py` - LLM request/response logging

### Testing
- `tests/conftest.py` - Shared fixtures and mock implementations
- `tests/test_e2e_classification.py` - End-to-end tests with real Azure OpenAI
- `tests/test_assets/` - Sample Reddit post JSON files for testing
- `tests/.env.example` - Example environment file for e2e tests

### CI/CD
- `.github/workflows/tests.yml` - GitHub Actions workflow for tests and linting

## Common Tasks

### Adding a New LLM Provider
1. Implement `ILLMAnalyzer` interface
2. Add to `src/analyzers/`
3. Create corresponding tests

### Modifying LLM Prompts
1. Edit `src/analyzers/prompts.yaml`
2. No code changes needed unless adding new prompt keys

### Adding a New Issue Category
1. Add to `IssueCategory` enum in `src/models/issue.py`
2. Update prompts in `src/analyzers/prompts.yaml`
3. Update tests accordingly

### Adding a Test Asset
1. Create a JSON file in `tests/test_assets/`
2. Use `RedditPost.from_dict()` to load in tests
3. Reference in `test_e2e_classification.py` or other tests

### Running E2E Tests
1. Copy `tests/.env.example` to `tests/.env`
2. Fill in Azure OpenAI credentials
3. Run `pytest tests/test_e2e_classification.py -v`
4. Tests auto-skip if credentials not configured

## Dependencies
- `openai` - Azure OpenAI client
- `pyyaml` - YAML parsing for prompts
- `python-dotenv` - Loading .env files for configuration
- `pytest` - Testing framework
- `pytest-cov` - Coverage reporting
- `ruff` - Linting (used in CI, optional locally)
